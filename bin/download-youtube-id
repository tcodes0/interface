#! /bin/bash

set -euo pipefail
shopt -s globstar

vid_id=${1:-}
format=${2:-}
destination=${3:-}

audio_only_format=251
video_audio_720p=22
desktop=~/Desktop

usage() {
  msgln "Usage: $0 <youtube_video_id> <format> <destination>"
  msgln formats:
  msgln audio only: $audio_only_format
  msgln video 720p: $video_audio_720p
  msgln more formats use yt-dlp --list-formats \$vid_id
  msgln format defaults to video 720p
  msgln destination defaults to desktop
}

if [ -z "$vid_id" ] || [ "$vid_id" == -h ] || [ "$vid_id" == --help ]; then
  usage
  fatal "No video id provided"
fi

if [ -z "$format" ]; then
  msgln defaulting to 720p video format
  format=$video_audio_720p
fi

if [ -z "$destination" ]; then
  msgln defaulting destination to desktop
  destination=$desktop
fi

temp_dir=$(mktemp -d youtube_dl-XXXXXX -p /tmp)
current_wd=$(pwd)

msgln using temp "$temp_dir"
cd "$temp_dir"

# download from youtube
if ! yt-dlp -f "$format" "$vid_id" --output "%(title)s-%(release_date)s.%(ext)s"; then
  yt-dlp "$vid_id" --list-formats
  fatal "yt-dlp error, formats supported above"
fi

# sanitize filename
if ! rename -z -c -S ___ _ -S _-_ - ./*; then
  fatal "rename video error"
fi

if [ "$format" == $audio_only_format ]; then
  # convert to mp3
  # we don't know filename but it's the only file in the folder because we used mktemp
  if ! ffmpeg -i "$temp_dir"/* -codec:a libmp3lame -q:a 0 out.mp3; then
    fatal "mp3 ffmpeg error"
  fi

  if ! find . -name "*.webm" -exec mv out.mp3 {}.mp3 \;; then
    fatal "mp3 find error"
  fi

  if ! rename -S .webm.mp3 .mp3 ./*; then
    fatal "mp3 rename webm to mp3 error"
  fi

  if ! mv ./*.mp3 ~/Desktop; then
    fatal "mp3 mv error"
  fi

  exit 0
fi

if ! mv ./* "$destination"; then
  fatal "mv error"
fi

cd "$current_wd"

msgln "done"
