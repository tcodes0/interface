#! /usr/bin/env bash
# Copyright 2025 Raphael Thomazella. All rights reserved.
# Use of this source code is governed by the BSD-3-Clause
# license that can be found in the LICENSE file and online
# at https://opensource.org/license/BSD-3-clause.
#
# checks if firefox is playing music and inhibits idle, fixes https://bugzilla.mozilla.org/show_bug.cgi?id=1665986
# also checks other apps passed as arguments, and inhibits sleep for them too.
# note: undefined functions are in lib.sh (sourced via BASH_ENV)
# shellcheck disable=SC2155

set -euo pipefail
shopt -s globstar
trap 'err $LINENO && cleanup' ERR INT TERM
trap 'cleanup' EXIT

### vars and functions ###

readonly inhibition_duration_secs=65
readonly pooling_interval_secs=60
readonly playing="Playing"
apps=("$@")
children=()

check_dependencies() {
  if [ -z "$BASH_ENV" ]; then
    echo "This script uses functions defined externally."
    echo "\$BASH_ENV is used to source dependencies, and is empty."
    echo "If functions are in the environment, please set BASH_ENV to any string."
    exit 1
  fi
}

help_exit() {
  msgln "Usage: $0"
  msgln
  msgln This tool is meant to be fire-and-forget by an automation.
  msgln It will work if invoked manually as well.
}

cleanup() {
  local pid

  for pid in "${children[@]}"; do
    # we do not care if the children is already terminated
    kill "$pid" 2>/dev/null || true
  done
}

check_firefox_playback() {
  # playerctl will error if there are no players, ignore that
  local status
  status=$(playerctl --player=plasma-browser-integration status 2>&1 || true)

  if [ "$status" = "$playing" ]; then
    systemd-inhibit --what=idle --who="$0" --why='Firefox is playing audio' sleep $inhibition_duration_secs &
    children+=("$!")
  fi
}

check_app_running() {
  local app="$1"

  if pgrep --quiet --exact "$app" 2>&1; then
    systemd-inhibit --what=idle --who="$0" --why="$app is running" sleep "$inhibition_duration_secs" &
    children+=("$!")
  fi
}

### script ###

check_dependencies

if requested_help "$*"; then
  help_exit
  exit 1
fi

while true; do
  check_firefox_playback

  for app in "${apps[@]}"; do
    check_app_running "$app"
  done

  sleep $pooling_interval_secs
done
